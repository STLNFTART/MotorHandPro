# MotorHandPro Multi-Service Development Environment
# Patent Pending: U.S. Provisional Patent Application No. 63/842,846

version: '3.9'

services:
  # ============================================================================
  # motorhand-api: LAM + Primal Logic FastAPI
  # ============================================================================
  motorhand-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: motorhandpro/api:latest
    container_name: motorhand-api
    command: ["uvicorn", "lam.api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    ports:
      - "8000:8000"
    volumes:
      - ./lam:/app/lam
      - ./extras:/app/extras
      - ./validation_results:/app/validation_results
      - ./ml_datasets:/app/ml_datasets
      - ./experiments:/app/experiments
      - lam-data:/data/lam
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - LAM_DATA_DIR=/data/lam
      - LAM_LOG_LEVEL=DEBUG
    env_file:
      - .env
    networks:
      - motorhand-network
    depends_on:
      - motorhand-worker
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # motorhand-worker: CPU-based simulations and analysis
  # ============================================================================
  motorhand-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: motorhandpro/worker:latest
    container_name: motorhand-worker
    command: ["python", "-u", "run_experiments.py"]
    volumes:
      - ./experiments:/app/experiments
      - ./validation_results:/app/validation_results
      - ./ml_datasets:/app/ml_datasets
      - ./logs:/app/logs
      - worker-data:/data
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - WORKER_MODE=cpu
    env_file:
      - .env
    networks:
      - motorhand-network
    restart: unless-stopped

  # ============================================================================
  # motorhand-ui: Control Panel Web Frontend
  # ============================================================================
  motorhand-ui:
    build:
      context: ./control_panel
      dockerfile: Dockerfile
    image: motorhandpro/ui:latest
    container_name: motorhand-ui
    ports:
      - "3000:3000"
    volumes:
      - ./control_panel:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - REACT_APP_API_URL=http://localhost:8000
      - REACT_APP_WS_URL=ws://localhost:8080
    depends_on:
      - motorhand-api
    networks:
      - motorhand-network
    restart: unless-stopped

  # ============================================================================
  # regulatory-api: FDA/Regulatory + RPO Integration
  # ============================================================================
  regulatory-api:
    build:
      context: ./regulatory-api
      dockerfile: Dockerfile
    image: motorhandpro/regulatory:latest
    container_name: regulatory-api
    command: ["npm", "start"]
    ports:
      - "9000:9000"
    volumes:
      - ./regulatory-api:/app
      - /app/node_modules
      - ./contracts:/app/contracts
    environment:
      - NODE_ENV=development
      - PORT=9000
      - API_URL=http://motorhand-api:8000
    env_file:
      - .env
    depends_on:
      - motorhand-api
    networks:
      - motorhand-network
    restart: unless-stopped

  # ============================================================================
  # nginx: Reverse Proxy & Static File Server
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: motorhand-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docs:/usr/share/nginx/html/docs:ro
      - ./wiki:/usr/share/nginx/html/wiki:ro
    depends_on:
      - motorhand-api
      - motorhand-ui
      - regulatory-api
    networks:
      - motorhand-network
    restart: unless-stopped

volumes:
  lam-data:
    driver: local
  worker-data:
    driver: local

networks:
  motorhand-network:
    driver: bridge
